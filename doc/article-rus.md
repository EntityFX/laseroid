# Портируем старую игру в жанре "shoot 'em up" на JavaScript

## Приступаем

Имеется древняя игрушка LaserAge, которая написана на Flash (на очень древнем Micromedia Flash 4) и работает только под Windows. В детстве она мне очень понравилась, поэтому я решил для души портировать её, чтобы можно было играть с браузера со всех устройств.

Цель игры заключается в том, чтобы уничтожать противников своим космическим кораблём на различных уровнях и получать бонусы, если поймать бонус - улучшается оружие. При попадании торпеды противника - даунгрейд оружия игрока.
При уничтожении всех противников на уровне происходит переключение на следующий уровень. Всего 100 уровней.
В терминах игры уровень - волна (Wave), а несколько волн объединены в большой уровень (Level), который представляет из себя просто смену заднего фона,
т. е. всего 4 больших уровня в каждом из которых 25 волн. В последней волне большого уровня обычно бывает босс - противник с огромным значением жизни и мощным оружием.

------


## Бизнес логика игры

### Игровое пространство

Представляет из себя обычную прямоугольную область, в верхней части располагаются корабли противника, а снизу игрок.
Область движения игрока ограничена так, что он не может сталкиваться с кораблями противника, а корабли противника с игроком.

### Оружие

Оружием обладает космический корабль игрока и корабли противника.
Оружие игрока может быть ручным (стреляет при нажатии мыши) и дополнительное автоматическое (стреляет периодами).
Оружие стреляет торпедами, алгоритм движения которых очень примитивный: торпеды противника движутся на игрока (сверху вниз), а торпеды игрока движутся снизу вверх.
При попадании торпеды противника в игрока вычитается 1 уровень жизни (апгрейда), при 0 игра завершается поражением.

#### Оружие космического корабля игрока

* Торпеда - стреляет маленькими ракетами
  * Одинарная Торпеда - 1 уровень апгрейда
  * Двойная - 2 уровень апгрейда
  * Тройная - 3 уровень апгрейда
* Автоматические пушки
  * Дополнительная автоматическая Торпеда слева корабля - 4 уровень апгрейда
  * Дополнительная автоматическая Торпеда справа корабля - 5 уровень апгрейда
* Зелёная плазма - 6 и 7 уровень апгрейда (увеличивается скорострельность)
* Фиолетовая плазма - 8 уровень апгрейда (наносит урон всем противникам по траектории полёта)
* Зелёный лазер - 9 уровень (наносит урон всем противникам, а также активно одну секунду, тем самым можно задеть соседних противников)

Дополнительное оружие:

* Красная плазма - 15-19  уровень (наносит урон всем противникам, а также активно одну секунду, тем самым можно задеть соседних противников)
* Зелёная плазма - 20-24 уровень
* Синяя плазма - 25-29 уровень апгрейда
* Фиолетовая плазма - 30-34 уровень апгрейда
* Фиолетовая плазма - 30-34 уровень апгрейда
* Дополнительная автоматическая Торпеда слева стреляет желтой плазмой - 35 - 39 уровень апгрейда
* Дополнительная автоматическая Торпеда справа стреляет желтой плазмой - 40+ уровень апгрейда

Таблица с характеристиками оружия игрока

| Оружие                 | Hit Points | Скорость спрайта | Интенсивность | Тип     | Дополнительно                     | Вид                                                          |
| ---------------------- | ---------- | ---------------- | ------------- | ------- | --------------------------------- | ------------------------------------------------------------ |
| Торпеда                | 1          | 5                | 25            | Торпеда | Одинарная, двойная, тройная       | ![](https://raw.githubusercontent.com/EntityFX/laseroid/master/resources/laser-age/graphics/Bullet1_1.png) |
| Автоматическая Торпеда | 1          | 5                | 50            | Торпеда | Слева и Справа                    | ![](https://raw.githubusercontent.com/EntityFX/laseroid/master/resources/laser-age/graphics/Weapon_1.png) |
| Зелёная плазма         | 3          | 7                | 30            | Торпеда |                                   | ![](https://raw.githubusercontent.com/EntityFX/laseroid/master/resources/laser-age/graphics/Bullet3_1.png) |
| Фиолетовая плазма      | 2          | 8                | 30            | Торпеда | Атакует до 3х целей               | ![](https://raw.githubusercontent.com/EntityFX/laseroid/master/resources/laser-age/graphics/Bullet7_1.png) |
| Красная плазма         | 2          | 4                | 30            | Торпеда |                                   | ![](https://raw.githubusercontent.com/EntityFX/laseroid/master/resources/laser-age/graphics/Bullet2_1.png) |
| Синяя плазма           | 4          | 4.5              | 30            | Торпеда |                                   | ![](https://raw.githubusercontent.com/EntityFX/laseroid/master/resources/laser-age/graphics/Bullet4_1.png) |
| Жёлтая плазма          | 2          | 3.8              | 40            | Торпеда | Только автоматическая             | ![](https://raw.githubusercontent.com/EntityFX/laseroid/master/resources/laser-age/graphics/Bullet6_1.png) |
| Зелёный Лазер          | 4          | -                | 15/55         | Лазер   | Атакует до 5ти целей одновременно | ![](https://raw.githubusercontent.com/EntityFX/laseroid/master/resources/laser-age/graphics/Bullet9_1.png) |

Таблица с конфигурацией оружия игрока в зависимости от уровня жизни

| Уровень жизни | Конфигурация оружия                                                                           |
| ------------- | --------------------------------------------------------------------------------------------- |
| 1             | Торпеда                                                                                       |
| 2             | Торпеда + Торпеда                                                                             |
| 3             | Торпеда + Торпеда + Торпеда                                                                   |
| 4             | Торпеда + Торпеда + Торпеда + Автоматическая торпеда слева                                    |
| 5             | Торпеда + Торпеда + Торпеда + Автоматическая торпеда слева + справа                           |
| 6             | Зелёная плазма + Автоматическая торпеда слева + справа                                        |
| 7             | Зелёная плазма + Автоматическая торпеда слева + справа                                        |
| 8             | Фиолетовая плазма + Автоматическая торпеда слева + справа                                     |
| 9             | Зелёный лазер + Автоматическая торпеда слева + справа                                         |
| 15 - 19       | Зелёный лазер + Красная плазма + Автоматическая торпеда слева + справа                        |
| 20 - 24       | Зелёный лазер + Красная плазма + Автоматическая торпеда слева + справа                        |
| 25 - 29       | Зелёный лазер + Синяя плазма + Автоматическая торпеда слева + справа                          |
| 30 - 34       | Зелёный лазер + Фиолетовая плазма + Автоматическая торпеда слева + справа                     |
| 35 - 39       | Зелёный лазер + Фиолетовая плазма + Автоматическая желтая плазма слева + торпеда справа       |
| 40+           | Зелёный лазер + Фиолетовая плазма + Автоматическая желтая плазма слева + желтая плазма справа |

#### Оружие противников

Таблица с конфигурацией оружия противников

| Оружие         | Скорость спрайта | Тип     |
| -------------- | ---------------- | ------- |
| Торпеда        | 2.5              | Торпеда |
| Красная плазма | 3.5              | Торпеда |
| Синяя плазма   | 4.5              | Торпеда |
| Зелёная плазма | 5                | Торпеда |
| Синяя Торпеда  | 3                | Торпеда |
| Жёлтая плазма  | 3.2 - 3.8        | Торпеда |
| Белая плазма   | 4 - 6            | Торпеда |
| Зелёный Лазер  | -                | Лазер   |

Для того чтобы исключить предсказуемость поведения оружия игроков, интенсивность имеет псевдослучайный характер.
Интенсивность оружия противников может иметь один и более временных слотов, в каждом отдельно задаётся минимальное и максимальное время фреймов и число повторов. Слот может быть паузой или активным состоянием (стреляет).

Пример конфигурации оружия:

```json
"torpedo": {
    "sprite": "Bullet1_1.png", //картинка спрайта
    "isRandomIntensity": false, //нужно ли переключать случайно слоты - true или по порядку - false
    "intensity": [
        //слот 0
        {
            "min": 50, //минимальное число фреймов
            "max": 200, //максимальное число фреймов
            "type": "pause" //pause - оружие неактивно, shoot - активное (стреляет)
        },
        //слот 1
        {
            "min": 100,
            "max": 200,
            "type": "shoot"
        },
        {
            "min": 50,
            "max": 80,
            "type": "pause"
        },
        {
            "min": 30,
            "max": 100,
            "repeat": 2
        }
    ],
    "speed": 2.5, //скорость
    "type": "bullet", //тип оружия
    "sound": "alienTorpedo"
}
```

### Действующие лица

#### Корабль игрока

Корабль игрока может перемещаться в ограниченной области, чтобы не пересекаться с кораблями противников.
Управляется движением мыши или стрелочками `←` и `→`. На экране мобильного телефона тапом и движением по экрану.
Оружие активирует при удержании левой клавиши мыши (тапом и удержанием по экрану на мобильном телефоне).

#### Противники

Для разнообразия на каждом уровне может быть различное число противников, каждый из которых обладает собственным набором оружия, имеет своё значение жизни, различную траекторию движения. противники могут быть обычные или боссами.

| Корабль противника           | Жизнь                    | Тип     | Движения                             | Оружие                                                                                                                                                          | Вид                                                                                                                                                      |
| ----------------------- | ------------------------ | ------- | ----------------------------------------------- | --------------------------------------------------------------------------------------------------------------------------------------------------------------- | --------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| Чужой 1                 | 2                        | Обычный | Нормальное горизонтальное          | Торпеда                                                                                                                                                         | ![](https://raw.githubusercontent.com/EntityFX/laseroid/master/resources/laser-age/graphics/AlienShip1_1.png)                               |
| Чужой 2                 | 4                        | Обычный | Нормальное все направления                      | Торпеда                                                                                                                                                         | ![](https://raw.githubusercontent.com/EntityFX/laseroid/master/resources/laser-age/graphics/AlienShip2_1.png)                                            |
| Быстрый чужой           | 10                       | Обычный | Быстрое горизонтальное             | Торпеда (Интенсивная)                                                                                                                                           | ![](https://raw.githubusercontent.com/EntityFX/laseroid/master/resources/laser-age/graphics/AlienShip3_1.png)                              |
| Фрегат чужого           | 10                       | Обычный | Нормально-быстрое все направления               | Красная плазма                                                                                                                                                  | ![](https://raw.githubusercontent.com/EntityFX/laseroid/master/resources/laser-age/graphics/AlienShip4_1.png)                                    |
| Броневик чужого         | 10                       | Обычный | Медленное вниз                                  | Торпеда (Очень интенсивная)                                                                                                                                     | ![](https://raw.githubusercontent.com/EntityFX/laseroid/master/resources/laser-age/graphics/AlienShip5_1.png)                       |
| Быстрый Фрегат чужого | 30                       | Обычный | Медленное вниз (следит за игроком)              | Красная плазма   (Очень интенсивная)                                                                                                                            | ![](https://raw.githubusercontent.com/EntityFX/laseroid/master/resources/laser-age/graphics/AlienShip6_1.png)              |
| Красный истребитель     | 30                       | Обычный | Медленное вниз (следит за игроком)              | Синяя плазма                                                                                                                                                    | ![](https://raw.githubusercontent.com/EntityFX/laseroid/master/resources/laser-age/graphics/AlienShip70_1.png)                                     |
| Зелёный истребитель     | 30                       | Обычный | Быстро вертикально                              | Синяя плазма                                                                                                                                                    | ![](https://raw.githubusercontent.com/EntityFX/laseroid/master/resources/laser-age/graphics/AlienShip7_1.png)                                      |
| Чужой 1 модификация     | 2                        | Обычный | Нормальное горизонтальное          | Синяя Торпеда                                                                                                                                                   | ![](https://raw.githubusercontent.com/EntityFX/laseroid/master/resources/laser-age/graphics/AlienShip1_1.png)                                      |
| Бомбардировщик          | 30                       | Обычный | Нормальное все направления  (следит за игроком) | Зелёная плазма                                                                                                                                                  | ![](https://raw.githubusercontent.com/EntityFX/laseroid/master/resources/laser-age/graphics/AlienShip8_1.png)                                    |
| Тяжёлый Чужой           | 30                       | Обычный | Нормальное все направления                      | Торпеда                                                                                                                                                         | ![](https://raw.githubusercontent.com/EntityFX/laseroid/master/resources/laser-age/graphics/AlienShip9_1.png)                                           |
| Тяжёлый Фрегат Чужого   | 35                       | Обычный | Нормальное все направления                      | Синяя Торпеда  + Синяя Торпеда                                                                                                                                  | ![](https://raw.githubusercontent.com/EntityFX/laseroid/master/resources/laser-age/graphics/AlienShip10_1.png)                    |
| Тяжёлый броневик        | 35                       | Обычный | Нормальное вниз                                 | Жёлтая Плазма + Жёлтая Плазма + Жёлтая Плазма + Жёлтая Плазма                                                                                                   | ![](https://raw.githubusercontent.com/EntityFX/laseroid/master/resources/laser-age/graphics/AlienShip11_1.png) |
| Линкор                  | 100                      | Босс    | Нормальное все направления                      | Синяя плазма (очень интенсивная) + Зелёная плазма (очень интенсивная)                                                                                           | ![](https://raw.githubusercontent.com/EntityFX/laseroid/master/resources/laser-age/graphics/BossShip1_1.png) |
| Крейсер                 | 250                      | Босс    | Нормальное все направления                      | Зелёная плазма (сверх интенсивная)                                                                                                                              | ![](https://raw.githubusercontent.com/EntityFX/laseroid/master/resources/laser-age/graphics/BossShip2_1.png) |
| Тяжёлый Крейсер         | 500                      | Босс    | Быстрое все направления                         | Жёлтая Плазма + Жёлтая Плазма + Синяя Торпеда + Синяя Торпеда + Синяя Торпеда + Синяя Торпеда + Белая плазма + Белая плазма                                     | ![](https://raw.githubusercontent.com/EntityFX/laseroid/master/resources/laser-age/graphics/BossShip3_1.png) |
| Эпичный Тяжёлый Крейсер | 1000 (восстанавливается) | Босс    | Быстрое все направления                         | Жёлтая Плазма + Жёлтая Плазма + Синяя Торпеда + Синяя Торпеда + Синяя Торпеда + Синяя Торпеда + Белая плазма + Белая плазма+ Зелёная плазма (очень интенсивная) | ![](https://raw.githubusercontent.com/EntityFX/laseroid/master/resources/laser-age/graphics/BossShip3_1.png) |

JSON-конфигурация противника:

```json
"alien10": {
    "life": 35,
    "weapons": [
        {
            "weapon": "blueTorpedo",
            "position": {
                "x": -6,
                "y": 0
            }
        },
        {
            "weapon": "blueTorpedo",
            "position": {
                "x": 6,
                "y": 0
            }
        }
    ],
    "sprite": "AlienShip10_1.png",
    "movement": "horizontalFast",
    "killPoints": 2100
}
```

JSON-конфигурация движения противника :

```json
"horizontalFast": {
    "movements": [
        {
            "type": "freeMovement", //freeMovement - обычное, followPlayer - следит за игроком (движется в направление)
            "speedDelta": {
                "vx": -6,
                "vy": 0
            },
            "intensity": [ //интенсивность движения в виде слотов
                {
                    "min": 20,
                    "max": 150
                },
                {
                    "min": 150,
                    "max": 350
                }
            ]
        }
    ]
}
```

## Выбор JavaScript библиотеки для реализации

Я просмотрел множество библиотек графики для JavaScript, но остановился на Hexi JS: https://github.com/kittykatattack/hexi .

Возможности библиотеки:

* Простота
* Рисование примитивов
* Рисование просты интерфейсов (кнопки, события)
* Перемещение, масштабирование, вращение
* Рисование спрайтов
  * Анимированные спрайты
  * Работа со спрайтами как с объектами
  * Загрузка спрайтов в виде большой текстуры - атласа. Можно разместить множество изображений в одном файлы и на выходе получить одну большую текстуру и JSON файл с описанием спрайтов (область, смещение)
* Логика столкновений
* Работа с устройствами ввода (клавиатура), тач-скрин.

Звуковая библиотека: https://github.com/kittykatattack/sound.js

Возможности библиотеки:

* Простота
* Воспроизведение звуков
* Воспроизведение музыки
* Эффекты

## Архитектура

Общая диаграмма классов:

![https://github.com/EntityFX/laseroid/blob/master/doc/diagrams/game.png?raw=true](https://github.com/EntityFX/laseroid/blob/master/doc/diagrams/game.png?raw=true)

### Иерархия классов действующих лиц